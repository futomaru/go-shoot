# 開発計画書: P2P Webブラウザシューティングゲーム「Go Shoot」

## 1. プロジェクト概要
- **目的**: ブラウザ上でプレイできるP2P型リアルタイムシューティングゲームをGo言語のみで実装し、モダンなUI/UXと高いパフォーマンスを実現する。
- **開発期間目安**: 4.5 ヶ月 (設計 3 週 / 実装 12 週 / テスト・調整 4 週 / リリース準備 2 週)
- **開発体制**: Goエンジニア 2〜3 名、UI/UX デザイナ 1 名、QA 1 名、DevOps 1 名。
- **主要技術**: Go 1.22+, WebAssembly (TinyGo), WebRTC DataChannel, AILERON Gateway, Docker, PostgreSQL, Redis。

## 2. 要件定義
### 2.1 機能要件
1. **ゲームロビー**
   - プレイヤーのマッチング (ルーム作成/参加)。
   - フレンド招待用リンク生成。
2. **ゲームプレイ**
   - 2〜4 人対戦のトップダウンシューティング。
   - 各プレイヤーの移動、射撃、HP 管理。
   - マップ上の障害物・アイテム生成。
   - 同期ずれ補正 (補間 / ロールバック)。
3. **P2P 通信**
   - WebRTC DataChannel を用いたプレイヤー間同期。
   - TURN/STUN サーバでの接続補助。
   - ルームホストのフェイルオーバー (ホスト切替機構)。
4. **アカウント・進行管理**
   - ゲストプレイ + ソーシャルログイン (外部 IdP)。
   - 戦績記録、ランキング表示。
5. **管理機能**
   - 管理者向けダッシュボード (マッチ数、接続状況)。
   - チート検知・BAN 申請ワークフロー。

### 2.2 非機能要件
- **パフォーマンス**: 80ms 以下のラウンドトリップを目標、60fps レンダリング。
- **可用性**: 主要サービス 99.5% 稼働、ホスト切替に 5 秒以内。
- **セキュリティ**: TLS 1.3、OWASP ASVS L2 に準拠。
- **拡張性**: プレイヤー数とマップを容易に追加可能なアーキテクチャ。
- **運用性**: Cloud Logging + Metrics、CI/CD パイプライン整備。

## 3. システムアーキテクチャ
### 3.1 全体構成
- ブラウザ (Go+WASM) クライアントが AILERON Gateway 経由でバックエンド API にアクセス。
- P2P WebRTC セッションをプレイヤー間で直接確立。シグナリングと認証を AILERON Gateway + Go バックエンドが担当。
- 状態保持用に PostgreSQL (永続データ) と Redis (セッション/ランキングキャッシュ) を使用。
- Docker コンテナで各サービス (API, シグナリング, TURN, フロントエンド配信) を運用。

### 3.2 コンポーネント
1. **WASM クライアント**
   - TinyGo でビルドした WebAssembly を使用し、描画は WebGL2 を Go バインディングで操作。
   - ECS (Entity Component System) 風のゲームロジック構造。
   - UI フレームワーク: Vecty または gio-wasm を検討。
2. **シグナリング/API サーバ**
   - Go (net/http + chi) で実装。
   - AILERON Gateway を API Gateway として配置し、認証/レート制御/監視を委譲。
   - WebSocket を用いたシグナリング、マッチングロジックを提供。
3. **ゲームマネージャ**
   - P2P セッションを監視し、ホストの障害時に再調整。
4. **TURN/STUN サーバ**
   - Coturn を Docker で運用 (Go での管理ツールを構築)。
5. **インフラ**
   - Docker Compose でローカル開発環境を構築、Kubernetes もしくは AILERON 推奨の Orchestrator で本番運用。

## 4. 開発フェーズとマイルストーン
1. **フェーズ 0: 企画・調査 (2 週)**
   - 競合調査、ゲームコンセプト確定、アートスタイル決定。
   - AILERON Gateway の機能調査と PoC。
2. **フェーズ 1: 設計 (3 週)**
   - ゲームデザイン仕様書、UI フロー。
   - アーキテクチャ設計、通信プロトコル定義。
   - データモデル、DB スキーマ設計。
3. **フェーズ 2: 基盤実装 (4 週)**
   - Go モノレポ構成整備、CI/CD (GitHub Actions)。
   - Docker 開発環境、WASM ビルドパイプライン構築。
   - シグナリング API と AILERON Gateway 連携 PoC。
4. **フェーズ 3: ゲームコア実装 (4 週)**
   - ECS 基盤、レンダリング、入力処理。
   - 基本武器、敵 AI、物理計算。
   - P2P 同期 (ポジション/アクション同期、補間ロジック)。
5. **フェーズ 4: メタゲーム & UI (4 週)**
   - ロビー/マッチング画面、モダンデザイン適用 (ダーク/ライトテーマ)。
   - 戦績、ランキング、アチーブメント。
   - 管理ツールの初期バージョン。
6. **フェーズ 5: QA & パフォーマンス最適化 (3 週)**
   - 負荷試験、ネットワーク遅延テスト、ブラウザ互換性。
   - セキュリティテスト、A/B テスト。
7. **フェーズ 6: リリース準備 (2 週)**
   - ドキュメント整備、運用 Runbook 作成。
   - リリース判定、ポストモーテム計画。

## 5. 技術的課題と対応方針
- **Go のみでのフロントエンド実装**: TinyGo + WASM と JavaScript ブリッジを最小化し、独自のレンダリングラッパーを整備。
- **P2P 同期の安定性**: ロールバックネットコードの検討、遅延測定と補償アルゴリズム。
- **AILERON Gateway 連携**: OAuth2.0 認証連携、API スキーマ (OpenAPI) を定義し自動デプロイ。
- **Docker 運用**: マルチステージビルドで軽量イメージ、IaC (Terraform) で本番環境をコード化。

## 6. 品質保証とテスト戦略
- **自動テスト**: Go のユニットテスト + WASM 向けヘッドレスブラウザテスト。
- **統合テスト**: docker-compose でのエンドツーエンドテスト、WebRTC モックを用いた CI テスト。
- **負荷テスト**: k6 + AILERON Gateway メトリクス活用。
- **コード品質**: golangci-lint、staticcheck を CI に組み込み。

## 7. デザイン指針
- モダンでミニマルな UI、グラデーションとニューモーフィズムのハイブリッド。
- アクセシビリティ (WCAG 2.1 AA)。
- レスポンシブデザインを念頭に置き、PC/タブレットに最適化。

## 8. リスク管理
- **WebRTC 接続不可率**: 初期から TURN サーバを冗長化。
- **Go+WASM の描画性能**: 早期にプロトタイプを作成しボトルネック計測。
- **チート・不正**: P2P でも重要処理をサーバで検証、リプレイ検証機能。
- **開発リソース不足**: アウトソース/コミュニティコンポーネントの活用計画。

## 9. 運用計画
- **監視**: Prometheus + Grafana、AILERON Gateway のメトリクスを統合。
- **ログ管理**: Cloud Logging (OpenTelemetry) を採用。
- **デプロイ**: main ブランチへのマージで CI が自動ビルド/テスト、ステージング→本番。
- **バックアップ**: DB は毎日スナップショット、Redis は永続化設定 (AOF)。

## 10. 今後のステップ
1. プロジェクトキックオフ、要件レビュー。
2. PoC (WASM レンダリング + WebRTC ハンドシェイク)。
3. 詳細設計レビューと開発環境整備。
